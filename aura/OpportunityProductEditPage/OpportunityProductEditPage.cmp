<aura:component controller="OpportunityProductEditController" implements="forceCommunity:availableForAllPageTypes" access="global">
    <aura:attribute name="oppyId" Type="String" access="global" />
    <aura:attribute name="oppy" Type="Opportunity" access="global" />
    <aura:attribute name="environmentType" Type="String" default="Lightning" />
    <aura:attribute name="openModal" type="Boolean" default="False" />
    <aura:attribute name="tooltip" type="Boolean" default="False" />
    <aura:attribute name="hoverRow" type="Integer" default="-1" />
    <aura:attribute name="tooltipmessage" type="String"  />
    <aura:attribute name="lstProductsAdded" Type="OPSWrapper[]" />
    <aura:attribute name="licenseTypes" type="String[]" />
    <aura:attribute name="riskStatuses" type="String[]" />
    <aura:attribute name="globalDiscountType" type="String" />
    <aura:attribute name="globalDiscountValue" type="Decimal" default="{!0}" />
    <aura:attribute name="globalUplift" type="Decimal" default="{!0}" />
    <aura:attribute name="globalDiscountStep" type="String" />
    <aura:attribute name="globalTermYears" type="String" />
    <aura:attribute name="globalProRateCheck" type="String" default="Yes"/>
    <aura:attribute name="isProrated" type="Boolean" />
    <!--<aura:attribute name="globalProRateCheck" type="Boolean" default="true"/>-->
    <aura:attribute name="noProductsMessage" type="String" />
    <aura:attribute name="showErrorMessage" type="Boolean" />    
    <aura:attribute name="indianLevyProdList" type="List" />
    <aura:attribute name="resetErrors" type="Boolean" default="true" />
    <aura:handler name="init" value="{!this}" action="{!c.doInit}" />
    <aura:attribute name="newlegalEntity" type="String" />
    <aura:attribute name="lstLegalEntity" type="LegalEntity__c[]" />
    <aura:attribute name="hasOppyEditAccess" type="Boolean" default="true" />
    <aura:attribute name="globalLicenseType" type="String" />
    <aura:attribute name="globalRiskStatus" type="String" />
    <aura:attribute name="globalRiskStatusHide" type="Boolean" default="true"/>
    <aura:attribute name="canBeProRated" type="Boolean" />
    <aura:attribute name="globalProRateDisplay" type="Boolean" default="false"/>
    <aura:attribute name="onAnnualPriceChange" type="Boolean" default="false"/>
    <aura:attribute name="globalProRate" type="String" />
    <aura:attribute name="autoRenewNoChanges" type="Boolean" default="false"/>
    <aura:attribute name="is6W" type="Boolean" default="false" />
    <aura:attribute name="sortOLIByFieldName" type="String" default="Product2.Name" />
    <aura:attribute name="sortOLIDirection" type="String" default="asc" />
    <aura:attribute name="sorting" type="Boolean" default="false" />
    <!--SFDC-4909 Change Start-->
    <aura:attribute name="lstAddedProducts" type="list"/>
    <aura:attribute name="lstMaterialCodes" type="String[]"/>
    <aura:attribute name="countOfInitialProductsAdded" type="Integer" default="0" />
    <aura:attribute name="countOfUpdatedProductsAdded" type="Integer" default="0" />
    <aura:attribute name="productsRemoved" type="Boolean" default="False" />
    <aura:handler name="modalCloseEvent" event="c:modalCloseEvt" action="{!c.closeModal}"/>
    <aura:attribute name="saveOrClose" type="String" />
    <!--SFDC-4909 Change End-->
    <lightning:spinner variant="brand" size="large" aura:id="loadSpinner2" class="slds-hide"/>
    <aura:if isTrue="{!!v.hasOppyEditAccess}">
        <div class="slds-scoped-notification slds-media slds-media_center slds-scoped-notification_light" role="status">
            <div class="slds-media__figure">
                <lightning:icon iconName="utility:info" variant="warning" />
            </div>
            <div class="slds-media__body">
                <p>{!$Label.c.OpportunityEditAccessError}</p>
            </div>
        </div>
    </aura:if>
    <aura:if isTrue="{!and(v.lstProductsAdded!=null,v.lstProductsAdded.length>0)}">
        <!--new page header combined with global sectiohn-->
        <div class="slds-page-header slds-scrollable_x">
            <div class="slds-grid">
                <div class="slds-col slds-has-flexi-truncate">
                    <div class="slds-media slds-no-space slds-grow">
                        <div class="slds-media__figure">
                            <lightning:icon iconName="standard:product" size="large" alternativeText="Edit Products" />
                        </div>
                        <div class="slds-media__body">
                            <nav>
                                <ol class="slds-breadcrumb slds-line-height_reset">
                                    <li class="slds-breadcrumb__item">
                                        <span>Edit Products</span>
                                    </li>
                                </ol>
                            </nav>
                            <h1 class="slds-page-header__title slds-m-right_small slds-align-middle slds-truncate" title="Legal Entity">
                                <b>{!'Legal Entity:'+v.oppy.LegalEntity__r.Name} </b>
                            </h1>
                        </div>
                    </div>
                </div>
            </div>
            <ul class="slds-grid slds-page-header__detail-row boldFont">
                <li class=" slds-size--1-of-1 slds-page-header__detail-block whiteSpaceClass  slds-align_absolute-center">
                    <h3 class="slds-page-header__title" title="Global Values">
                        <b>Global Values </b>
                    </h3>
                </li>
            </ul>
            <ul class="slds-grid slds-page-header__detail-row boldFont">
                <li class="slds-page-header__detail-block whiteSpaceClass">
                    <lightning:select name="globalLicense" value="{!v.globalLicenseType}" label="License Type " onchange="{!c.onGlobalLicenseTypeChange}" disabled="{!v.autoRenewNoChanges}" >
                        <option value="">--None--</option>
                        <aura:iteration var="licenseType" items="{!v.licenseTypes}">
                            <option value="{!licenseType}">{!licenseType}</option>
                        </aura:iteration>
                    </lightning:select>
                </li>
                <li class="slds-page-header__detail-block whiteSpaceClass slds-border_left">
                    <lightning:select name="globalDiscount" value="{!v.globalDiscountType}" label="Discount Type" onchange="{!c.onGlobalDiscountTypeChange}" disabled="{!or(v.oppy.RecordType.DeveloperName=='Gratis',and(v.autoRenewNoChanges,!v.oppy.PriceChangeOnly__c),v.is6W)}">
                        <option value="No Discount">No Discount</option>
                        <option value="Amount">Amount</option>
                        <option value="Percentage">Percentage</option>
                    </lightning:select>

                </li>
                <li class="slds-page-header__detail-block whiteSpaceClass">
                    <lightning:select name="globalStep" value="{!v.globalDiscountStep}" label="Discount Step" onchange="{!c.onGlobalDiscountChange}" disabled="{!v.globalDiscountType=='No Discount'}">
                        <option value="Flat">Flat</option>
                        <option value="Step up">Step up</option>
                        <option value="Step down">Step down</option>
                    </lightning:select>
                </li>
                <li class="slds-size--1-of-8 slds-page-header__detail-block whiteSpaceClass">
                    <lightning:input type="number" name="globalDiscountValue" label="{! 'Discount Value' +if(v.globalDiscountType=='Amount','('+v.oppy.CurrencyIsoCode+')','') + if(v.globalDiscountType=='Percentage','(%)','')}" formatter="decimal" step="any" min="0" value="{!v.globalDiscountValue}"
                        aura:id="globalDiscount" disabled="{!v.globalDiscountType=='No Discount'}" onchange="{!c.onGlobalDiscountChange}" />
                </li>
                <li class="slds-size--1-of-12 slds-page-header__detail-block whiteSpaceClass slds-border_left">
                    <lightning:input type="number" name="globalUplift" label="Uplift(%)" formatter="decimal" step="any" min="0" value="{!v.globalUplift}" aura:id="Uplift" onchange="{!c.onUpliftChange}" disabled="{!or(v.oppy.RecordType.DeveloperName=='Gratis',v.autoRenewNoChanges,v.is6W)}" />
                </li>
                <li class="slds-size--1-of-12 slds-page-header__detail-block whiteSpaceClass slds-border_left">
                    <lightning:select name="globalTerm" value="{!v.globalTermYears}" label="Years" onchange="{!c.onGlobalTermChange}" disabled="{!v.autoRenewNoChanges}">
                        <option value="1">1 Year</option>
                        <option value="2">2 Years</option>
                        <option value="3">3 Years</option>
                        <option value="4">4 Years</option>
                        <option value="5">5 Years</option>
                    </lightning:select>
                </li>
                <li class="slds-size--1-of-8 slds-page-header__detail-block whiteSpaceClass slds-m-left_small slds-border_left">
                    <lightning:layout verticalAlign="end" class="columns">
                        <lightning:layoutItem>
                            <lightning:select name="sortOLIField" value="{!v.sortOLIByFieldName}" label="Sort By">
                                <option value="Product2.Name">Product Name</option>
                                <option value="MaterialCode__c">Material Code</option>
                            </lightning:select>
                        </lightning:layoutItem>
                      	   <lightning:layoutItem padding="around-x_small">
                            <lightning:buttonIcon class="custom-box" size="large" iconName="utility:sort" alternativeText="Sort" title="Sort" onclick="{!c.sortOLI}"/>
                        </lightning:layoutItem>
                    </lightning:layout>
                </li>
                <li class="slds-size--1-of-12 slds-page-header__detail-block slds-border_left">
                    <ui:inputCheckbox label="Product At Risk(Select All)" aura:id="selectAll" change="{!c.onGlobalProdRiskChange}"/>    
                </li>
                <li class="slds-page-header__detail-block ">
                    <lightning:select name="globalRisk" value="{!v.globalRiskStatus}" label="Risk Status" aura:id="globalRiskStatus" onchange="{!c.onGlobalRiskStatusChange}" disabled="{!v.globalRiskStatusHide}" >
                        <option value="">--None--</option>
                        <aura:iteration var="riskStatus" items="{!v.riskStatuses}">
                            <option value="{!riskStatus}">{!riskStatus}</option>
                        </aura:iteration>
                    </lightning:select>
                </li> 
                 
                <!--<li class="slds-page-header__detail-block slds-border_left">         
                    <ui:inputCheckbox label="Proration Required" value="{!v.globalProRateCheck}" aura:id="ProrateCheck" change="{!c.onProRateRequired}"/>                            	
                </li> -->               
                <aura:if isTrue="{!v.globalProRateDisplay}">
                <li>
                <lightning:select name="Proration Required" label="Proration Required" value="{!v.globalProRateCheck}" onchange="{!c.onProRateRequired}">
                    <option value="No">No</option>
                    <option value="Yes">Yes</option>
                </lightning:select>
                </li>
                </aura:if>
                <!-- commenting as pro-ration will be done in ihs release
                <li class="slds-page-header__detail-block whiteSpaceClass slds-border_left inlineClass">

                    <lightning:select name="globalProration" value="{!v.globalProRate}" label="Pro-Rate" onchange="{!c.onProRate}" disabled="{!!v.canBeProRated}">
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                    </lightning:select>
                    <lightning:helptext class="{!v.canBeProRated?'slds-hide':'slds-show'}" content="{!$Label.c.ProRationError}" />
                </li>-->
            </ul>
        </div>
        <aura:if isTrue="{!v.showErrorMessage}">
            <div class="slds-p-around_xx-small slds-text-color_error">
                <p>{!$Label.c.NegativeSalesPriceError}</p>
            </div>
        </aura:if>
        <!-- new page header combined with global section ends-->

        <!--Product section begins-->
        <div class="slds-p-bottom_xx-large">
            <lightning:card title="Products" iconName="standard:product" class="card-classinner slds-p-horizontal_small ">
                <aura:set attribute="title">
                    <p class="slds-text-heading--medium "><b>Products</b></p>
                </aura:set>
                <aura:iteration var="prod" items="{!v.lstProductsAdded}" indexVar="prodIndex">
                    <aura:if isTrue="{!!prod.isDeleted}">
                        <div class="slds-form">
                            <lightning:card title="{!prod.oppyProduct.Product2.Name}" class="card-product" variant="narrow">
                                <aura:set attribute="title">
                                    <div class="slds-size--1-of-1 slds-align_absolute-center">

                                        <b><ui:outputText class="field" value="{!prod.oppyProduct.Product2.Name}" /></b>
                                        <ui:outputText class="field slds-p-left_large" value="Material Code:" /><br/>
                                        <ui:outputText class="field slds-p-left_small" value="{!prod.oppyProduct.MaterialCode__c}" />

                                    </div>
                                </aura:set>
                                <aura:set attribute="actions">
                                    <aura:if isTrue="{!!prod.isDeleted}">
                                        <lightning:button variant="base" type="submit" label="Collapse" name="{!'collapse'+prod.oppyProduct.Id}" onclick="{!c.collapse}" /> |
                                        <lightning:button variant="base" type="submit" label="Remove" onclick="{!c.remove}" name="{!prodIndex+'remove'}" disabled="{!and(prod.status!='New',v.hasOppyEditAccess)}" />
                                    </aura:if>
                                </aura:set>

                                <div id="{!prod.oppyProduct.Id}">
                                    <!-- Field section begins -->
                                    <div class="slds-grid slds-wrap">
                                        <div class="slds-size--12-of-12 slds-p-top_large slds-p-around_xx-small ">
                                            <table class="slds-table  slds-table_cell-buffer slds-max-medium-table_stacked-horizontal  slds-table--fixed-layout">
                                                <thead>
                                                    <tr class="slds-text-body_small boldFont">
                                                        <th scope="col" class="slds-size--1-of-12">
                                                        <div class="whiteSpaceNormal" title="Status">Status</div>
                                                    </th>
                                                        <th scope="col" class="slds-size--1-of-12">
                                                        <div class="whiteSpaceNormal" title="Is Product at Risk">Is Product at Risk</div>
                                                    </th>
                                                        <th scope="col" class="slds-size--1-of-12">
                                                        <div class="whiteSpaceNormal" title="Risk Status">Risk Status</div>
                                                    </th>
                                                        <th scope="col" class="slds-size--1-of-12">
                                                        <div class="whiteSpaceNormal" title="LicenseType">License Type</div>
                                                    </th>
                                                        <th scope="col" class="slds-size--1-of-12">
                                                        <div class="whiteSpaceNormal" title="Quantity">Quantity</div>
                                                    </th>
                                                        <th scope="col" class="slds-size--1-of-12">
                                                        <div class="whiteSpaceNormal" title="DiscountType">Discount Type</div>
                                                    </th>
                                                        <th scope="col" class="slds-size--1-of-12">
                                                        <div class="whiteSpaceNormal" title="Years">Years</div>
                                                    </th>
                                                        <th scope="col" class="slds-size--1-of-12">
                                                        <div class="whiteSpaceNormal" title="Recommended Unit Price">Recommended Unit Price</div>
                                                    </th>
                                                        <th scope="col" class="slds-size--1-of-12">
                                                        <div class="whiteSpaceNormal" title="Prior year price">Prior year price</div>
                                                    </th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <td data-label="Status">
                                                        <div>
                                                            <aura:if isTrue="{!and(prod.status=='New',v.oppy.RecordType.DeveloperName!='NewBusiness')}">
                                                                <b><ui:outputText class="field slds-p-around_xx-small" value="{!prod.status}"/></b>
                                                            </aura:if>
                                                            <aura:if isTrue="{!and(prod.status!='Existing',v.oppy.RecordType.DeveloperName=='NewBusiness')}">
                                                               <lightning:select name="{!'status'+prodIndex}" value="{!prod.status}" variant="label-hidden" required="true" disabled="{!v.autoRenewNoChanges}">
                                                                    <option value="New">New</option>
                                                                    <option value="Lost">Lost</option>
                                                                </lightning:select>                                                           
                                                            </aura:if>
                                                            <aura:if isTrue="{!and(prod.status!='New',v.oppy.RecordType.DeveloperName!='NewBusiness')}">
                                                                <lightning:select name="{!'status'+prodIndex}" value="{!prod.status}" variant="label-hidden" required="true" disabled="{!v.autoRenewNoChanges}">
                                                                    <option value="Existing">Existing</option>
                                                                    <option value="Lost">Lost</option>
                                                                </lightning:select>
                                                            </aura:if>
                                                        </div>
                                                    </td>
                                                    <td data-label="Is Product At Risk">
                                                        <div>
                                                            <lightning:select name="{!'prodRisk'+prodIndex}" value="{!prod.oppyProduct.IsProductatRisk__c}" onchange="{!c.onRiskStatusChange}" variant="label-hidden" disabled="{!prod.status !='Existing'}">
                                                                    <option value="No">No</option>
                                                                    <option value="Yes">Yes</option>
                                                            </lightning:select>                                                             
                                                        </div>                                                                                                              
                                                    </td>
                                                    <td data-label="Risk Status">
                                                        <lightning:select name="{!'riskStatus'+prodIndex}" value="{!prod.oppyProduct.RiskStatus__c}" variant="label-hidden" aura:id="riskStatus" disabled="{!prod.oppyProduct.IsProductatRisk__c=='No'}">
                                                                <option value="">--None--</option>
                                                                <aura:iteration var="riskStatus" items="{!v.riskStatuses}" indexVar="indexLT">
                                                                    <option value="{!riskStatus}">{!riskStatus}</option>
                                                                </aura:iteration>
                                                        </lightning:select>
                                                    </td>
                                                    <td data-label="License Type">
                                                        <div class="hiddenLabel">
                                                            <lightning:select name="{!'licenseType'+prodIndex}" value="{!prod.oppyProduct.LicenseType__c}" variant="label-hidden" required="true" aura:id="licenseTypes" onchange="{!c.onLicenseTypeChange}" disabled="{!v.autoRenewNoChanges}">
                                                                <option value="">--None--</option>
                                                                <aura:iteration var="licenseType" items="{!v.licenseTypes}" indexVar="indexLT">
                                                                    <option value="{!licenseType}">{!licenseType}</option>
                                                                </aura:iteration>
                                                            </lightning:select>
                                                        </div>
                                                    </td>
                                                    <td data-label="Quantity">
                                                        <div>
                                                            <lightning:input type="number" name="{!prodIndex+'qty'}" value="{!prod.productQty}" onchange="{!c.onQtyChange}" variant="label-hidden" min="1" disabled="{!v.autoRenewNoChanges}" />
                                                        </div>
                                                    </td>
                                                    <td data-label="Discount Type">
                                                        <div class="hiddenLabel">
                                                            <lightning:select name="{!'discountType'+prodIndex}" value="{!prod.discountType}" variant="label-hidden" onchange="{!c.onDiscountTypeChange}" disabled="{!or(v.oppy.RecordType.DeveloperName=='Gratis',and(v.autoRenewNoChanges,!v.oppy.PriceChangeOnly__c),v.is6W)}">
                                                                <option value="No Discount">No Discount</option>
                                                                <option value="Amount">Amount</option>
                                                                <option value="Percentage">Percentage</option>
                                                            </lightning:select>
                                                        </div>
                                                    </td>
                                                    <td data-label="Years">
                                                        <div class="hiddenLabel">
                                                            <lightning:select name="{!prodIndex}" label="Years" variant="label-hidden" onchange="{!c.productTermChange}" value="{!prod.productTermSelected}" disabled="{!v.autoRenewNoChanges}" >
                                                                <aura:iteration var="prodOPS" items="{!prod.lstMapOPSIndex}" indexVar="index">
                                                                    <option value="{!prodOPS}">{!prodOPS}</option>
                                                                </aura:iteration>
                                                            </lightning:select>
                                                        </div>
                                                    </td> 
                                                    <td data-label="Recommended Unit Price">
                                                        <div>
                                                            <lightning:formattedNumber value="{!prod.oppyProduct.RecommendedUnitPrice__c}" style="currency" currencyCode="{!v.oppy.CurrencyIsoCode}" currencyDisplayAs="symbol" />
                                                            <aura:if isTrue="{!prod.oppyProduct.RecommendedUnitPrice__c==null}">
                                                                <lightning:formattedNumber value="{!0}" style="currency" currencyCode="{!v.oppy.CurrencyIsoCode}" currencyDisplayAs="symbol" />
                                                            </aura:if>
                                                        </div>
                                                    </td>
                                                    <td data-label="Prior year price">
                                                        <div>
                                                            <lightning:formattedNumber value="{!prod.oppyProduct.PriorYearTotalSalesPrice__c}" style="currency" currencyCode="{!v.oppy.CurrencyIsoCode}" currencyDisplayAs="symbol" />
                                                            <aura:if isTrue="{!prod.oppyProduct.PriorYearTotalSalesPrice__c==null}">
                                                                <lightning:formattedNumber value="{!0}" style="currency" currencyCode="{!v.oppy.CurrencyIsoCode}" currencyDisplayAs="symbol" />
                                                            </aura:if>
                                                        </div>
                                                    </td>
                                                </tbody>
                                                <br></br>
                                                <thead>
                                                    <tr class="slds-text-body_small boldFont">
                                                        <th scope="col" class="slds-size--1-of-12">
                                                            <div class="whiteSpaceNormal" title="Probability">Probability</div>
                                                        </th>
                                                        <th scope="col" class="slds-size--1-of-12">
                                                            <div class="whiteSpaceNormal" title="LocationSites"># of Locations /Sites</div>
                                                        </th>
                                                        <th scope="col" class="slds-size--1-of-12">
                                                            <div class="whiteSpaceNormal" title="Concurrent Users"># of concurrent users</div>
                                                        </th>
                                                        <th scope="col" class="slds-size--1-of-12">
                                                            <div class="whiteSpaceNormal" title="Potential Users"># of potential users</div>
                                                        </th>
                                                        <th scope="col" class="slds-size--1-of-12">
                                                            <div class="whiteSpaceNormal" title="Authorized Users"># of Authorized Users</div>
                                                        </th>
                                                        <th scope="col" class="slds-size--1-of-12">
                                                            <div class="whiteSpaceNormal" title="Description">Description</div>
                                                        </th>
                                                        <th scope="col" class="slds-size--1-of-12">
                                                            <div class="whiteSpaceNormal" title="Estimated Value At Risk">Estimated Value At Risk</div>
                                                        </th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <td data-label="Probability">
                                                        <div>
                                                            <lightning:input type="number" value="{!prod.oppyProduct.Probability__c}" variant="label-hidden" min="0"  aura:id="probabilities"/>
                                                        </div>
                                                    </td>
                                                    <td data-label="# of Locations/Sites">
                                                        <div>
                                                            <lightning:input type="number" value="{!prod.oppyProduct.NumberofLocationsSites__c}" variant="label-hidden" min="0" disabled="{!v.autoRenewNoChanges}" aura:id="loactionSites"/>
                                                        </div>
                                                    </td>
                                                    <td data-label="# of concurrent users">
                                                        <div>
                                                            <lightning:input type="number" value="{!prod.oppyProduct.NumberofConcurrentUsersSeats__c}" variant="label-hidden" min="0" disabled="{!v.autoRenewNoChanges}" aura:id="concurrentUsers"/>
                                                        </div>
                                                    </td>
                                                    <td data-label="# of potential users">
                                                        <div>
                                                            <lightning:input type="number" value="{!prod.oppyProduct.NumberofPotentialUsers__c}" variant="label-hidden" min="0"  disabled="{!v.autoRenewNoChanges}" aura:id="potentialUsers"/>
                                                        </div>
                                                    </td>
                                                    <td data-label="Authorized users">
                                                        <div>
                                                            <lightning:input type="number" value="{!prod.oppyProduct.AuthorizedUsers__c}" variant="label-hidden" min="0"  disabled="{!v.autoRenewNoChanges}" aura:id="authorizedUsers"/>
                                                        </div>
                                                    </td>
                                                    <td data-label="Description">
                                                        <div>
                                                            <lightning:input type="text" name="prodDesc" value="{!prod.oppyProduct.Description}" variant="label-hidden" disabled="{!v.autoRenewNoChanges}" />
                                                        </div>
                                                    </td>
                                                    <td data-label="Estimated Value">
                                                        <div>
                                                            <lightning:input type="number" name="{!index+'estValueRisk'+prodIndex}" onchange="{!c.onEstimateValueRisk}" variant="label-hidden" formatter="decimal" step="any" value="{!prod.oppyProduct.IsProductatRisk__c=='No'? '' : prod.oppyProduct.EstimatedValueatRisk__c}"  aura:id="EstimatedValue" disabled="{!prod.oppyProduct.IsProductatRisk__c=='No'}" />
                                                        </div>
                                                    </td>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                    <!--Field section ends-->
                                    <!--table section begins-->
                                    <div class="slds-grid slds-wrap">
                                        <div class="slds-size--1-of-1 slds-m-top_large slds-scrollable slds-p-around_large ">
                                            <table class="slds-table slds-table_bordered slds-table_cell-buffer slds-max-medium-table_stacked-horizontal slds-border_left slds-border_right">
                                                <thead>
                                                    <tr class="slds-text-body_small boldFont">
                                                        <th scope="col">
                                                            <div class="slds-truncate" title="Year">Year</div>
                                                        </th>
                                                        <th scope="col">
                                                            <div class="slds-truncate" title="Price Book List Price">Price Book List Price</div>
                                                        </th>
                                                        <aura:if isTrue="{!and(v.globalProRateCheck == 'Yes',prod.oppyProduct.Product2.AAG__c == 'Subscription')}">
                                                        <th scope="col">
                                                            <div class="slds-truncate" title="Annualized Unit Price">Annualized Unit Price</div>
                                                        
                                                            </th>   
                                                        <th scope="col">
                                                            <div class="slds-truncate" title="Annualized Discount Percent">Annualized Discount Percent(%)</div>
                                                        </th>
                                                        <th scope="col">
                                                            <div class="slds-truncate" title="Annualized Discount Amount">Annualized Discount Amount</div>
                                                        </th>
                                                        <th scope="col">
                                                            <div class="slds-truncate" title="Annualized Total Amount">Annualized Total Amount</div>
                                                        </th>
                                                        <th scope="col">
                                                            <div class="slds-truncate" title="Updated List Price">Pro-Rated Price</div>
                                                        </th>                                                              
                                                        <th scope="col">
                                                            <div class="slds-truncate" title="ProRated Discount Percent">Discount Percent(%) (Pro-Rated)</div>
                                                        </th>
                                                        <th scope="col">
                                                            <div class="slds-truncate" title="ProRated Discount Amount">Discount Amount (Pro-Rated)</div>
                                                        </th>
                                                        <th scope="col">
                                                            <div class="slds-truncate" title="ProRated Net Unit Price">Net Unit Price (Pro-Rated)</div>
                                                        </th>
                                                        <th scope="col">
                                                            <div class="slds-truncate" title="ProRated Total Price">Total Price (Pro-Rated)</div>
                                                        </th>	
                                                        </aura:if>
                                                        
                                                        <aura:if isTrue="{!!and(v.globalProRateCheck == 'Yes',prod.oppyProduct.Product2.AAG__c == 'Subscription')}">
                                                        <th scope="col">
                                                            <div class="slds-truncate" title="Updated List Price">Updated List Price</div>
                                                        </th>            
                                                        <th scope="col">
                                                            <div class="slds-truncate" title="Discount Percent">Discount Percent(%)</div>
                                                        </th>
                                                        <th scope="col">
                                                            <div class="slds-truncate" title="Discount Amount">Discount Amount</div>
                                                        </th>
                                                        <th scope="col">
                                                            <div class="slds-truncate" title="Net Unit Price">Net Unit Price</div>
                                                        </th>
                                                        <th scope="col">
                                                            <div class="slds-truncate" title="Total Price">Total Price</div>
                                                        </th>	
                                                        </aura:if>
                                                        <!--                                                     
                                                        <aura:if isTrue ="{!and(prod.oppyProduct.Product2.AAG__c == 'Subscription',and(v.globalProRateCheck == 'Yes',v.globalProRateDisplay))}"> 
                                                            <th scope="col">
                                                                <div class="slds-truncate" title="ProRated Discount">Pro-Rated Discount %</div> 
                                                            </th>
                                                            <th scope="col">
                                                                <div class="slds-truncate" title="ProRated Discount Amount">Pro-Rated Discount Amount</div>
                                                            </th>
                                                             <th scope="col">
                                                                <div class="slds-truncate" title="ProRated Unit Price ">Pro-Rated Unit Price</div> 
                                                            </th>
                                                             <th scope="col">
                                                                <div class="slds-truncate" title="ProRated Total Price ">Pro-Rated Total Price</div> 
                                                            </th>
                                                        </aura:if>
                                                       -->
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <aura:iteration var="prodOPS" items="{!prod.lstOPS}" indexVar="index">
                                                        <tr>
                                                            <th scope="row" data-label="Year">
                                                                <div class="slds-truncate" title="{!prodOPS.InstallmentYears__c}"><b><p>{!prodOPS.InstallmentYears__c}</p></b>
                                                                </div>
                                                            </th>
                                                            <td data-label="Price Book List Price">
                                                                <div>
                                                                    <lightning:formattedNumber value="{!prodOPS.PriceBookListPrice__c}" style="currency" currencyCode="{!prodOPS.CurrencyIsoCode}" currencyDisplayAs="symbol" />
                                                                </div>
                                                            </td>
                                                            <aura:if isTrue="{!v.resetErrors}">
                                                                <aura:if isTrue="{!and(v.globalProRateCheck == 'Yes',prod.oppyProduct.Product2.AAG__c == 'Subscription')}">
                                                                <td data-label="Annualized Unit Price">
                                                                    <div>
                                                                        <lightning:input type="number" label="{!index+prod.oppyProduct.MaterialCode__c}" name="{!index+'Anannualizedprice'+prodIndex}" variant="label-hidden" formatter="decimal" step="any" value="{!prodOPS.AnnualizedUnitPrice__c}" aura:id="annualizedUnitPrice" min="0" onchange="{!c.onAnnualizedPriceChange}" onfocus="{!c.onannualUnitPriceFocus}" onblur="{!c.resettooltip}" />                                                                        
                                                                        <aura:if isTrue="{!v.hoverRow==index+prod.oppyProduct.MaterialCode__c }" >                                        
                                                                            <div  class=" slds-popover_tooltip slds-nubbin_bottom-left slds-is-fixed" role="tooltip" style="position:absolute;top:-35px;left:35px;max-width:fit-content">
                                                                                <div class="slds-popover__body">Adjusted Annualized Unit Price is 
                                                                                 <lightning:formattedNumber value="{!v.tooltipmessage}" style="currency" currencyCode="{!prodOPS.CurrencyIsoCode}" currencyDisplayAs="symbol" /> due to Indian Levy.
                                                                                </div>
                                                                            </div>
                                                                        </aura:if>
                                                                    </div>
                                                                </td>  
                                                                <td data-label="Annualized Discount Percent(%)">  
                                                                    <div>
                                                                        <lightning:input type="number" name="{!index+'AndiscountPercent'+prodIndex}" variant="label-hidden" value="{!prodOPS.AnnualizedDiscountPercent__c}" step="any" aura:id="discountPercent" max="100" messageWhenRangeOverflow="Discount cannot be greater than 100%" disabled="{!or(prod.discountType!='Percentage',and(v.autoRenewNoChanges,v.is6W))}"
                                                                            min="0.00" onblur="{!c.roundOffDiscounts}" onchange="{!c.onAnnualizedDiscountChange}"/> 
                                                                    </div>
                                                                </td>
                                                                <td data-label="Annualized Discount Amount"> 
                                                                    <div>
                                                                        <lightning:input type="number" name="{!index+'AndiscountAmount'+prodIndex}" variant="label-hidden" formatter="decimal" step="any" min="0.00" value="{!prodOPS.AnnualizedDiscountAmount__c}" aura:id="discountAmount" disabled="{!or(prod.discountType!='Amount',and(v.autoRenewNoChanges,v.is6W))}" 
                                                                            max="{!prodOPS.AnnualizedUnitPrice__c}" messageWhenRangeOverflow="Discount cannot be greater than sales price" onblur="{!c.roundOffDiscounts}" onchange="{!c.onAnnualizedDiscountChange}"/> <!-- onchange="{!c.onDiscAmtPercentChange}"-->
                                                                    </div>
                                                                </td>
                                                                <td data-label="Annualized Total Amount">
                                                                  <div>
                                                                       <lightning:formattedNumber value="{!prodOPS.AnnualizedTotalAmount__c}" style="currency" currencyCode="{!prodOPS.CurrencyIsoCode}" currencyDisplayAs="symbol" />
                                                                  </div>
                                                                </td>
                                                                <td data-label="Updated List Price">
                                                                     <div>
                                                                        <lightning:formattedNumber value="{!prodOPS.ExternalListPrice__c}" style="currency" currencyCode="{!prodOPS.CurrencyIsoCode}" currencyDisplayAs="symbol" />
                                                                    </div> 
                                                                </td>                                                      
                                                                <td data-label="Pro Rated Discount Percent">
                                                                    <div>
                                                                        <lightning:formattedNumber value="{!prodOPS.DiscountPercent__c}" style="decimal" currencyCode="{!prodOPS.CurrencyIsoCode}" currencyDisplayAs="symbol" />
                                                                    </div>
                                                                </td>
                                                                <td data-label="Pro Rated Discount Amount">
                                                                    <div>
                                                                        <lightning:formattedNumber value="{!prodOPS.DiscountAmount__c}" style="currency" currencyCode="{!prodOPS.CurrencyIsoCode}" currencyDisplayAs="symbol" />
                                                                    </div>    
                                                                </td>    
                                                                </aura:if>
                                                                
                                                                <aura:if isTrue="{!!and(v.globalProRateCheck == 'Yes',prod.oppyProduct.Product2.AAG__c == 'Subscription')}">
                                                                <td data-label="Updated List Price">                                                                                                                                      
                                                                    <div>
                                                                        <lightning:input label="{!index+prod.oppyProduct.MaterialCode__c}" type="number" name="{!index+'extListPrice'+prodIndex}" variant="label-hidden" formatter="decimal" step="any" value="{!prodOPS.ExternalListPrice__c}" aura:id="externalListPrice" min="0" onfocus="{!c.onlistPriceFocus}" onchange="{!c.onListPriceChange}" onblur="{!c.resettooltip}" disabled="{!or(v.oppy.RecordType.DeveloperName=='Gratis',and(v.autoRenewNoChanges,!v.oppy.PriceChangeOnly__c),v.is6W)}"
                                                                                         />                                                                        
                                                                     	<aura:if isTrue="{!v.hoverRow==index+prod.oppyProduct.MaterialCode__c}" >
                                                                            <div  class=" slds-popover_tooltip slds-nubbin_bottom-left slds-is-fixed" role="tooltip" id="{!prodOPS.InstallmentYears__c+prod.oppyProduct.MaterialCode__c}" style="position:absolute;top:-35px;left:35px">
                                                                                <div class="slds-popover__body">Adjusted List Price is 
                                                                                 <lightning:formattedNumber value="{!v.tooltipmessage}" style="currency" currencyCode="{!prodOPS.CurrencyIsoCode}" currencyDisplayAs="symbol" /> due to Indian Levy.
                                                                                </div>
                                                                            </div>
                                                                        </aura:if>
                                                                    </div>                                                                 
                                                                </td>                                                           
                                                                <td data-label="Discount Percent">                                  
                                                                    <div>
                                                                        <lightning:input type="number" name="{!index+'discountPercent'+prodIndex}" variant="label-hidden" value="{!prodOPS.DiscountPercent__c}" step="any" aura:id="discountPercent" max="100" messageWhenRangeOverflow="Discount cannot be greater than 100%" disabled="{!or(prod.discountType!='Percentage',and(v.autoRenewNoChanges,v.is6W))}"
                                                                            min="0.00" onchange="{!c.onDiscAmtPercentChange}" onblur="{!c.roundOffDiscounts}" />
                                                                    </div>                                                 
                                                                </td>
                                                                <td data-label="Discount Amount">                                                                  
                                                                    <div>
                                                                        <lightning:input type="number" name="{!index+'discountAmount'+prodIndex}" variant="label-hidden" formatter="decimal" step="any" min="0.00" value="{!prodOPS.DiscountAmount__c}" aura:id="discountAmount" disabled="{!or(prod.discountType!='Amount',and(v.autoRenewNoChanges,v.is6W))}" onchange="{!c.onDiscAmtPercentChange}"
                                                                            max="{!prodOPS.ExternalListPrice__c}" messageWhenRangeOverflow="Discount cannot be greater than sales price" onblur="{!c.roundOffDiscounts}" />
                                                                    </div>
                                                                </td>
                                                            </aura:if>
                                                                
                                                            <td data-label="Net Unit Price">
                                                                <div>
                                                                    <lightning:formattedNumber value="{!prodOPS.SalesPrice__c}" style="currency" currencyCode="{!prodOPS.CurrencyIsoCode}" currencyDisplayAs="symbol" />
                                                                </div>
                                                            </td>
                                                            <td data-label="Total Price">
                                                                <div>
                                                                    <lightning:formattedNumber value="{!prodOPS.TotalPrice__c}" style="currency" currencyCode="{!prodOPS.CurrencyIsoCode}" currencyDisplayAs="symbol" />
                                                                </div>
                                                            </td>
                                                            </aura:if>    
                                                        </tr>
                                                    </aura:iteration>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <!--table section ends-->
                                    <aura:if isTrue ="{!prod.isIndianLevyProd}"> 
                                        <div class="slds-notify slds-notify_alert slds-alert_warning" role="alert">
                                            <span class="slds-assistive-text">info</span>
                                            <h2 aura:id="indianLevy"> {!$Label.c.IndianLevyMessage}
                                            </h2>
                                        </div>
                                    </aura:if>
                                    <aura:if isTrue ="{!and(prod.oppyProduct.Product2.Division__c != 'Financial Services', prod.oppyProduct.Product2.Division__c != 'OSTTRA')}"> 
                                        <aura:if isTrue ="{!prod.oppyProduct.LicenseType__c=='Enterprise Wide License'}"> 
                                            <div class="slds-notify slds-notify_alert slds-alert_warning" role="alert">
                                                <span class="slds-assistive-text">info</span>
                                                <h2 aura:id="licenseTypes"> {!$Label.c.LicenseTypeEnterpriseMessage}
                                                </h2>
                                            </div>
                                        </aura:if>
                                        <aura:if isTrue ="{!or(or(prod.oppyProduct.LicenseType__c=='Customer License',prod.oppyProduct.LicenseType__c=='Divisional License'), or(or(prod.oppyProduct.LicenseType__c=='Departmental License',prod.oppyProduct.LicenseType__c=='User License'),prod.oppyProduct.LicenseType__c=='Site License'))}">
                                            <div class="slds-notify slds-notify_alert slds-alert_warning" role="alert">
                                                <span class="slds-assistive-text">info</span>
                                                <h2 aura:id="licenseTypes"> {!$Label.c.LicenseTypeGeneralMessage}
                                                </h2>
                                            </div>
                                        </aura:if>
                                    </aura:if>
                                </div>
                            </lightning:card>
                        </div>
                    </aura:if>
                </aura:iteration>
            </lightning:card>
        </div>
        <!--Product section ends-->
        <lightning:overlayLibrary aura:id="overlayMessages" />
        <lightning:spinner variant="brand" size="large" class="slds-hide" aura:id="loadSpinner" />
        <div class="slds-m-top_xx-large slds-docked-form-footer">
            <aura:if isTrue="{!v.hasOppyEditAccess}">
                <lightning:button variant="brand" label="Reset" iconName="utility:undo" iconPosition="right" onclick="{!c.reset}" disabled="{!!v.hasOppyEditAccess}" />
                <lightning:button variant="brand" label="Add Product" iconName="utility:new" iconPosition="right" onclick="{!c.addProducts}" aura:id="addProducts" type="submit" disabled="{!!v.hasOppyEditAccess || v.showErrorMessage}" />
                <!--SFDC-4909 Change Start-->
                <!--<lightning:button variant="brand" label="Save" iconName="utility:save" iconPosition="right" onclick="{!c.save}" aura:id="save" type="submit" disabled="{!!v.hasOppyEditAccess || v.showErrorMessage}" />
                <lightning:button variant="brand" label="Save and Close" iconName="utility:save" iconPosition="right" onclick="{!c.close}" aura:id="close" type="submit" disabled="{!!v.hasOppyEditAccess || v.showErrorMessage}" />-->
                <lightning:button variant="brand" label="Save" iconName="utility:save" iconPosition="right" onclick="{!c.openModal}" aura:id="save" type="submit" disabled="{!!v.hasOppyEditAccess || v.showErrorMessage}" />
                <lightning:button variant="brand" label="Save and Close" iconName="utility:save" iconPosition="right" onclick="{!c.openModal}" aura:id="close" type="submit" disabled="{!!v.hasOppyEditAccess || v.showErrorMessage}" />
                <!--SFDC-4909 Change End-->
                <!--SFDC-4730 Change Start-->
                <!--<lightning:button variant="brand" label="Change Legal Entity" iconName="utility:change_record_type" iconPosition="right" onclick="{!c.openModal}" disabled="{!!v.hasOppyEditAccess || v.showErrorMessage ||  v.autoRenewNoChanges}" />-->
                <lightning:button variant="brand" label="Change Legal Entity" iconName="utility:change_record_type" iconPosition="right" onclick="{!c.onChangeLegalEntity}" disabled="{!!v.hasOppyEditAccess || v.showErrorMessage ||  v.autoRenewNoChanges}" />
                <!--SFDC-4730 Change End-->
                <lightning:button variant="brand" label="Cancel" iconName="utility:close" iconPosition="right" onclick="{!c.cancel}" />
                <aura:set attribute="else">
                    <lightning:button variant="brand" label="Go back" iconName="utility:left" iconPosition="left" onclick="{!c.cancel}" />
                </aura:set>
            </aura:if>

        </div>
        <!--SFDC-4730 Change Start
        <aura:if isTrue="{!v.openModal}">
            <div class="demo-only" style="height: 640px;">
                <div role="dialog" tabindex="-1" class="slds-modal slds-fade-in-open">
                    <div class="slds-modal__container">
                        <div class="slds-modal__header">
                            <button class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse" title="Close" onclick="{!c.closeModal}">
                                X
                                <span class="slds-assistive-text">Close</span>
                            </button>
                            <h2 id="modal-heading-01" class="slds-text-heading_medium slds-hyphenate">Change Legal Entity?</h2>
                        </div>
                        <div class="slds-modal__content slds-p-around_medium" id="modal-content-id-1">
                            <p> {!$Label.c.LegalEntityError} </p>
                            <p>Please select new legal entity below:</p>
                            <lightning:select name="legalEntity" value="{!v.newlegalEntity}" label="Legal Entity" variant="label-hidden">
                                <option value="- -None- -">- -None- -</option>
                                <aura:iteration var="legEnt" items="{!v.lstLegalEntity}" indexVar="LE">
                                    <option value="{!legEnt.Id}">{!legEnt.Name}</option>
                                </aura:iteration>
                            </lightning:select>
                        </div>
                        <footer class="slds-modal__footer">
                            <lightning:button variant="brand" label="No" onclick="{!c.closeModal}" aura:id="noLegalEntity" />
                            <lightning:button variant="brand" label="Yes" onclick="{!c.changeLegalEntity}" aura:id="yesLegalEntity" disabled="{!if(v.newlegalEntity!='- -None- -',false,true)}" />
                        </footer>
                    </div>
                </div>
                <div class="slds-backdrop slds-backdrop_open"></div>
            </div>
        </aura:if>
		SFDC-4730 Change End-->
        <!--SFDC-4909 Change Start-->
        <aura:if isTrue="{!v.openModal}">
            <div class="demo-only">
                <div role="dialog" tabindex="-1" class="slds-modal slds-fade-in-open slds-modal_medium"> 
                    <lightning:card class="modal-background">
                    	<div class="slds-modal__container">
                        	<div class="slds-modal__header slds-modal__header_empty">
                            	<button class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse" title="Close" onclick="{!c.newCloseModal}">
                                	X
                                	<span class="slds-assistive-text">Close</span>
                            	</button>
                        	</div>
                        	<div class="slds-modal__content slds-p-around_medium" id="modal-content-id-1">
                            	<c:legalEntitySelector  oppyId="{!v.oppyId}"
                                                   		lstProductsSelected="{!v.lstAddedProducts}"
                                                   		lstMaterialCodes="{!v.lstMaterialCodes}"
                                                   		lstCurrentProductsSelected="{!v.lstAddedProducts}"
                                                        productsRemoved = "{!v.productsRemoved}"
                                                        lstProductsAdded = "{!v.lstProductsAdded}" />
                        	</div>
                    	</div> 
                    </lightning:card>
                </div>
                <div class="slds-backdrop slds-backdrop_open"></div>
            </div>        
        </aura:if>
        <!--SFDC-4909 Change End-->
    </aura:if>
	
    <aura:if isTrue="{!v.noProductsMessage}">
        <div class="slds-grid slds-grid_align-center slds-grid_vertical">
            <div class="slds-col slds-container_fluid slds-align_absolute-center">
                <p class="slds-text-heading--medium slds-text-color_error"><b>{!v.noProductsMessage}</b></p>
            </div>
            <div class="slds-col  slds-m-top_large slds-container_fluid slds-align_absolute-center">
                <lightning:button variant="brand" label="Go Back" iconName="utility:back" iconPosition="right" onclick="{!c.cancel}" />
            </div>
        </div>
    </aura:if>
</aura:component>